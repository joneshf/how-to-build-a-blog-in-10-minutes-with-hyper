// Generated by purs version 0.11.4
"use strict";
var Control_Bind = require("../Control.Bind");
var Control_IxMonad = require("../Control.IxMonad");
var Control_Monad = require("../Control.Monad");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_Class = require("../Control.Monad.Eff.Class");
var Data_Functor = require("../Data.Functor");
var Data_Maybe = require("../Data.Maybe");
var Data_Monoid = require("../Data.Monoid");
var Data_Semigroup = require("../Data.Semigroup");
var Data_StrMap = require("../Data.StrMap");
var Data_String = require("../Data.String");
var Data_Tuple = require("../Data.Tuple");
var Data_Unit = require("../Data.Unit");
var Hyper_Authentication = require("../Hyper.Authentication");
var Hyper_Conn = require("../Hyper.Conn");
var Hyper_Middleware = require("../Hyper.Middleware");
var Hyper_Middleware_Class = require("../Hyper.Middleware.Class");
var Hyper_Request = require("../Hyper.Request");
var Hyper_Response = require("../Hyper.Response");
var Hyper_Status = require("../Hyper.Status");
var Node_Buffer = require("../Node.Buffer");
var Node_Encoding = require("../Node.Encoding");
var decodeBase64 = function (dictMonadEff) {
    return function (encoded) {
        return Control_Monad_Eff_Class.liftEff(Hyper_Middleware.monadEffMiddleware(dictMonadEff))(Control_Bind.bind(Control_Monad_Eff.bindEff)(Node_Buffer.fromString(encoded)(Node_Encoding.Base64.value))(Node_Buffer.toString(Node_Encoding.ASCII.value)));
    };
};
var withAuthentication = function (dictMonadEff) {
    return function (dictRequest) {
        return function (mapper) {
            var splitPair = function (s) {
                var v = Data_String.split(":")(s);
                if (v.length === 2) {
                    return new Data_Maybe.Just(new Data_Tuple.Tuple(v[0], v[1]));
                };
                return Data_Maybe.Nothing.value;
            };
            var getAuth = Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Hyper_Request.getRequestData(dictRequest))(function (v) {
                var v1 = Data_StrMap.lookup("authorization")(v.headers);
                if (v1 instanceof Data_Maybe.Nothing) {
                    return Control_IxMonad.ipure(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Data_Maybe.Nothing.value);
                };
                if (v1 instanceof Data_Maybe.Just) {
                    var v2 = Data_String.split(" ")(v1.value0);
                    if (v2.length === 2 && v2[0] === "Basic") {
                        return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Data_Functor.map(Hyper_Middleware.functorMiddleware(dictMonadEff.Monad0()))(splitPair)(decodeBase64(dictMonadEff)(v2[1])))(function (v3) {
                            if (v3 instanceof Data_Maybe.Just) {
                                return Hyper_Middleware["lift'"](dictMonadEff.Monad0())(mapper(v3.value0));
                            };
                            if (v3 instanceof Data_Maybe.Nothing) {
                                return Control_IxMonad.ipure(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Data_Maybe.Nothing.value);
                            };
                            throw new Error("Failed pattern match at Hyper.Node.BasicAuth line 60, column 15 - line 62, column 41: " + [ v3.constructor.name ]);
                        });
                    };
                    return Control_IxMonad.ipure(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Data_Maybe.Nothing.value);
                };
                throw new Error("Failed pattern match at Hyper.Node.BasicAuth line 54, column 7 - line 63, column 35: " + [ v1.constructor.name ]);
            });
            return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(getAuth)(function (v) {
                return Hyper_Middleware_Class.modifyConn(Hyper_Middleware.ixMonadMiddleware(dictMonadEff.Monad0()))(Hyper_Middleware.ixMonadMiddlewareMiddleware((dictMonadEff.Monad0()).Applicative0()))(Hyper_Authentication.setAuthentication(v));
            });
        };
    };
};
var authenticated = function (dictMonad) {
    return function (dictResponseWritable) {
        return function (dictResponse) {
            return function (realm) {
                return function (mw) {
                    return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Middleware_Class.getConn(Hyper_Middleware.ixMonadMiddlewareMiddleware(dictMonad.Applicative0())))(function (v) {
                        if (v.components.authentication instanceof Data_Maybe.Nothing) {
                            return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(Hyper_Status.statusUnauthorized))(function (v1) {
                                return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeHeader(dictResponse)(new Data_Tuple.Tuple("WWW-Authenticate", "Basic realm=\"" + (realm + "\""))))(function (v2) {
                                    return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.closeHeaders(dictResponse))(function (v3) {
                                        return Hyper_Response.respond(dictMonad)(dictResponseWritable)(dictResponse)("Please authenticate.");
                                    });
                                });
                            });
                        };
                        if (v.components.authentication instanceof Data_Maybe.Just) {
                            return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Middleware_Class.modifyConn(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Middleware.ixMonadMiddlewareMiddleware(dictMonad.Applicative0()))(Hyper_Authentication.setAuthentication(v.components.authentication.value0)))(function (v1) {
                                return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(mw)(function (v2) {
                                    return Hyper_Middleware_Class.modifyConn(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Middleware.ixMonadMiddlewareMiddleware(dictMonad.Applicative0()))(Hyper_Authentication.setAuthentication(new Data_Maybe.Just(v.components.authentication.value0)));
                                });
                            });
                        };
                        throw new Error("Failed pattern match at Hyper.Node.BasicAuth line 84, column 3 - line 93, column 49: " + [ v.components.authentication.constructor.name ]);
                    });
                };
            };
        };
    };
};
module.exports = {
    authenticated: authenticated, 
    decodeBase64: decodeBase64, 
    withAuthentication: withAuthentication
};
