// Generated by purs version 0.11.4
"use strict";
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_IxMonad = require("../Control.IxMonad");
var Control_Monad_Error_Class = require("../Control.Monad.Error.Class");
var Control_Monad_Except = require("../Control.Monad.Except");
var Control_Monad_Except_Trans = require("../Control.Monad.Except.Trans");
var Control_Semigroupoid = require("../Control.Semigroupoid");
var Data_Array = require("../Data.Array");
var Data_Boolean = require("../Data.Boolean");
var Data_Either = require("../Data.Either");
var Data_Eq = require("../Data.Eq");
var Data_Foldable = require("../Data.Foldable");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_Generic_Rep = require("../Data.Generic.Rep");
var Data_Generic_Rep_Eq = require("../Data.Generic.Rep.Eq");
var Data_Generic_Rep_Show = require("../Data.Generic.Rep.Show");
var Data_HTTP_Method = require("../Data.HTTP.Method");
var Data_HeytingAlgebra = require("../Data.HeytingAlgebra");
var Data_Maybe = require("../Data.Maybe");
var Data_MediaType_Common = require("../Data.MediaType.Common");
var Data_Semigroup = require("../Data.Semigroup");
var Data_Show = require("../Data.Show");
var Data_StrMap = require("../Data.StrMap");
var Data_String = require("../Data.String");
var Data_Symbol = require("../Data.Symbol");
var Data_Traversable = require("../Data.Traversable");
var Data_Tuple = require("../Data.Tuple");
var Hyper_Conn = require("../Hyper.Conn");
var Hyper_ContentNegotiation = require("../Hyper.ContentNegotiation");
var Hyper_Middleware = require("../Hyper.Middleware");
var Hyper_Request = require("../Hyper.Request");
var Hyper_Response = require("../Hyper.Response");
var Hyper_Status = require("../Hyper.Status");
var Prelude = require("../Prelude");
var Type_Proxy = require("../Type.Proxy");
var Type_Trout = require("../Type.Trout");
var Type_Trout_ContentType = require("../Type.Trout.ContentType");
var Type_Trout_PathPiece = require("../Type.Trout.PathPiece");
var HTTPError = (function () {
    function HTTPError(value0) {
        this.value0 = value0;
    };
    HTTPError.create = function (value0) {
        return new HTTPError(value0);
    };
    return HTTPError;
})();
var Router = function (route) {
    this.route = route;
};
var MethodRouter = function (routeMethod) {
    this.routeMethod = routeMethod;
};
var routeMethod = function (dict) {
    return dict.routeMethod;
};
var routerResource = function (dictIsSymbol) {
    return function (dictMethodRouter) {
        return new Router(function (proxy) {
            return routeMethod(dictMethodRouter)(Type_Proxy["Proxy"].value);
        });
    };
};
var routerResourceMethods = function (dictMethodRouter) {
    return function (dictMethodRouter1) {
        return new Router(function (proxy) {
            return function (ctx) {
                return function (v) {
                    var v1 = routeMethod(dictMethodRouter)(Type_Proxy["Proxy"].value)(ctx)(v.value0);
                    if (v1 instanceof Data_Either.Left) {
                        return routeMethod(dictMethodRouter1)(Type_Proxy["Proxy"].value)(ctx)(v.value1);
                    };
                    if (v1 instanceof Data_Either.Right) {
                        return Control_Applicative.pure(Data_Either.applicativeEither)(v1.value0);
                    };
                    throw new Error("Failed pattern match at Hyper.Trout.Router line 253, column 5 - line 255, column 24: " + [ v1.constructor.name ]);
                };
            };
        });
    };
};
var routeEndpoint = function (dictIsSymbol) {
    return function (v) {
        return function (context) {
            return function (r) {
                return function (methodProxy) {
                    return Control_Bind.discard(Control_Bind.discardUnit)(Data_Either.bindEither)(Control_Applicative.unless(Data_Either.applicativeEither)(Data_Array["null"](context.path))(Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                        status: Hyper_Status.statusNotFound, 
                        message: Data_Maybe.Nothing.value
                    }))))(function () {
                        var expectedMethod = Data_HTTP_Method.fromString(Data_Symbol.reflectSymbol(dictIsSymbol)(methodProxy));
                        return Control_Bind.discard(Control_Bind.discardUnit)(Data_Either.bindEither)(Control_Applicative.unless(Data_Either.applicativeEither)(Data_Eq.eq(Data_Either.eqEither(Data_HTTP_Method.eqMethod)(Data_HTTP_Method.eqCustomMethod))(expectedMethod)(context.method))(Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                            status: Hyper_Status.statusMethodNotAllowed, 
                            message: new Data_Maybe.Just("Method " + (Data_Show.show(Data_Either.showEither(Data_HTTP_Method.showMethod)(Data_HTTP_Method.showCustomMethod))(context.method) + (" did not match " + (Data_Show.show(Data_Either.showEither(Data_HTTP_Method.showMethod)(Data_HTTP_Method.showCustomMethod))(expectedMethod) + "."))))
                        }))))(function () {
                            return Control_Applicative.pure(Data_Either.applicativeEither)(r);
                        });
                    });
                };
            };
        };
    };
};
var routerRaw = function (dictIsSymbol) {
    return new Router(function (proxy) {
        return function (context) {
            return function (r) {
                return routeEndpoint(dictIsSymbol)(proxy)(context)(r)(Data_Symbol.SProxy.value);
            };
        };
    });
};
var route = function (dict) {
    return dict.route;
};
var router = function (dictMonad) {
    return function (dictRequest) {
        return function (dictRouter) {
            return function (site) {
                return function (handler) {
                    return function (onRoutingError) {
                        var splitUrl = function ($153) {
                            return Data_Array.filter(Data_Eq.notEq(Data_Eq.eqString)(""))(Data_String.split("/")($153));
                        };
                        var context = function (v) {
                            return {
                                path: splitUrl(v.url), 
                                method: v.method
                            };
                        };
                        var $$catch = function (v) {
                            return onRoutingError(v.value0.status)(v.value0.message);
                        };
                        var handler$prime = Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Data_Functor.map(Hyper_Middleware.functorMiddleware(dictMonad))(context)(Hyper_Request.getRequestData(dictRequest)))(function (v) {
                            var v1 = route(dictRouter)(site)(v)(handler);
                            if (v1 instanceof Data_Either.Left) {
                                return $$catch(v1.value0);
                            };
                            if (v1 instanceof Data_Either.Right) {
                                return v1.value0;
                            };
                            throw new Error("Failed pattern match at Hyper.Trout.Router line 312, column 7 - line 314, column 20: " + [ v1.constructor.name ]);
                        });
                        return handler$prime;
                    };
                };
            };
        };
    };
};
var routerAltE = function (dictRouter) {
    return function (dictRouter1) {
        return new Router(function (v) {
            return function (context) {
                return function (v1) {
                    var fallbackStatuses = [ Hyper_Status.statusNotFound, Hyper_Status.statusMethodNotAllowed ];
                    var selectError = function (v2) {
                        return function (v3) {
                            var v4 = new Data_Tuple.Tuple(v2.value0.status, v3.value0.status);
                            if (Data_Foldable.elem(Data_Foldable.foldableArray)(Hyper_Status.eqStatus)(v4.value0)(fallbackStatuses) && Data_Eq.eq(Hyper_Status.eqStatus)(v4.value1)(Hyper_Status.statusNotFound)) {
                                return new HTTPError(v2.value0);
                            };
                            if (Data_Eq.notEq(Hyper_Status.eqStatus)(v4.value0)(Hyper_Status.statusNotFound) && Data_Foldable.elem(Data_Foldable.foldableArray)(Hyper_Status.eqStatus)(v4.value1)(fallbackStatuses)) {
                                return new HTTPError(v2.value0);
                            };
                            if (Data_Boolean.otherwise) {
                                return new HTTPError(v3.value0);
                            };
                            throw new Error("Failed pattern match at Hyper.Trout.Router line 83, column 9 - line 87, column 42: " + [ v4.constructor.name ]);
                        };
                    };
                    var v2 = route(dictRouter)(Type_Proxy["Proxy"].value)(context)(v1.value0);
                    if (v2 instanceof Data_Either.Left) {
                        var v3 = route(dictRouter1)(Type_Proxy["Proxy"].value)(context)(v1.value1);
                        if (v3 instanceof Data_Either.Left) {
                            return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(selectError(v2.value0)(v3.value0));
                        };
                        if (v3 instanceof Data_Either.Right) {
                            return Control_Applicative.pure(Data_Either.applicativeEither)(v3.value0);
                        };
                        throw new Error("Failed pattern match at Hyper.Trout.Router line 75, column 9 - line 78, column 40: " + [ v3.constructor.name ]);
                    };
                    if (v2 instanceof Data_Either.Right) {
                        return Control_Applicative.pure(Data_Either.applicativeEither)(v2.value0);
                    };
                    throw new Error("Failed pattern match at Hyper.Trout.Router line 73, column 5 - line 79, column 36: " + [ v2.constructor.name ]);
                };
            };
        });
    };
};
var routerCapture = function (dictRouter) {
    return function (dictFromPathPiece) {
        return new Router(function (v) {
            return function (ctx) {
                return function (r) {
                    var v1 = Data_Array.uncons(ctx.path);
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                            status: Hyper_Status.statusNotFound, 
                            message: Data_Maybe.Nothing.value
                        }));
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        var v2 = Type_Trout_PathPiece.fromPathPiece(dictFromPathPiece)(v1.value0.head);
                        if (v2 instanceof Data_Either.Left) {
                            return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                                status: Hyper_Status.statusBadRequest, 
                                message: new Data_Maybe.Just(v2.value0)
                            }));
                        };
                        if (v2 instanceof Data_Either.Right) {
                            return route(dictRouter)(Type_Proxy["Proxy"].value)((function () {
                                var $105 = {};
                                for (var $106 in ctx) {
                                    if ({}.hasOwnProperty.call(ctx, $106)) {
                                        $105[$106] = ctx[$106];
                                    };
                                };
                                $105.path = v1.value0.tail;
                                return $105;
                            })())(r(v2.value0));
                        };
                        throw new Error("Failed pattern match at Hyper.Trout.Router line 116, column 9 - line 120, column 72: " + [ v2.constructor.name ]);
                    };
                    throw new Error("Failed pattern match at Hyper.Trout.Router line 111, column 5 - line 120, column 72: " + [ v1.constructor.name ]);
                };
            };
        });
    };
};
var routerCaptureAll = function (dictRouter) {
    return function (dictFromPathPiece) {
        return new Router(function (v) {
            return function (ctx) {
                return function (r) {
                    var v1 = Data_Traversable.traverse(Data_Traversable.traversableArray)(Data_Either.applicativeEither)(Type_Trout_PathPiece.fromPathPiece(dictFromPathPiece))(ctx.path);
                    if (v1 instanceof Data_Either.Left) {
                        return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                            status: Hyper_Status.statusBadRequest, 
                            message: new Data_Maybe.Just(v1.value0)
                        }));
                    };
                    if (v1 instanceof Data_Either.Right) {
                        return route(dictRouter)(Type_Proxy["Proxy"].value)((function () {
                            var $114 = {};
                            for (var $115 in ctx) {
                                if ({}.hasOwnProperty.call(ctx, $115)) {
                                    $114[$115] = ctx[$115];
                                };
                            };
                            $114.path = [  ];
                            return $114;
                        })())(r(v1.value0));
                    };
                    throw new Error("Failed pattern match at Hyper.Trout.Router line 128, column 5 - line 132, column 68: " + [ v1.constructor.name ]);
                };
            };
        });
    };
};
var routerLit = function (dictRouter) {
    return function (dictIsSymbol) {
        return new Router(function (v) {
            return function (ctx) {
                return function (r) {
                    var expectedSegment = Data_Symbol.reflectSymbol(dictIsSymbol)(Data_Symbol.SProxy.value);
                    var v1 = Data_Array.uncons(ctx.path);
                    if (v1 instanceof Data_Maybe.Just && v1.value0.head === expectedSegment) {
                        return route(dictRouter)(Type_Proxy["Proxy"].value)((function () {
                            var $119 = {};
                            for (var $120 in ctx) {
                                if ({}.hasOwnProperty.call(ctx, $120)) {
                                    $119[$120] = ctx[$120];
                                };
                            };
                            $119.path = v1.value0.tail;
                            return $119;
                        })())(r);
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                            status: Hyper_Status.statusNotFound, 
                            message: Data_Maybe.Nothing.value
                        }));
                    };
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEither)(new HTTPError({
                            status: Hyper_Status.statusNotFound, 
                            message: Data_Maybe.Nothing.value
                        }));
                    };
                    throw new Error("Failed pattern match at Hyper.Trout.Router line 95, column 5 - line 103, column 42: " + [ v1.constructor.name ]);
                };
            };
        });
    };
};
var getAccept = function (m) {
    var v = Data_StrMap.lookup("accept")(m);
    if (v instanceof Data_Maybe.Just) {
        return Data_Functor.map(Data_Either.functorEither)(Data_Maybe.Just.create)(Hyper_ContentNegotiation.parseAcceptHeader(v.value0));
    };
    if (v instanceof Data_Maybe.Nothing) {
        return Control_Applicative.pure(Data_Either.applicativeEither)(Data_Maybe.Nothing.value);
    };
    throw new Error("Failed pattern match at Hyper.Trout.Router line 161, column 3 - line 163, column 28: " + [ v.constructor.name ]);
};
var methodRouterMethod = function (dictMonad) {
    return function (dictRequest) {
        return function (dictResponse) {
            return function (dictResponseWritable) {
                return function (dictIsSymbol) {
                    return function (dictAllMimeRender) {
                        return new MethodRouter(function (proxy) {
                            return function (context) {
                                return function (action) {
                                    var handler = Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Middleware["lift'"](dictMonad)(Control_Monad_Except_Trans.runExceptT(action)))(function (v) {
                                        if (v instanceof Data_Either.Left) {
                                            return Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(v.value0.value0.status))(Hyper_Response.contentType(dictMonad)(dictResponse)(Data_MediaType_Common.textPlain)))(Hyper_Response.closeHeaders(dictResponse)))(Hyper_Response.end(dictResponse));
                                        };
                                        if (v instanceof Data_Either.Right) {
                                            return Control_IxMonad.ibind(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Request.getRequestData(dictRequest))(function (v1) {
                                                var v2 = getAccept(v1.headers);
                                                if (v2 instanceof Data_Either.Left) {
                                                    return Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(Hyper_Status.statusBadRequest))(Hyper_Response.contentType(dictMonad)(dictResponse)(Data_MediaType_Common.textPlain)))(Hyper_Response.closeHeaders(dictResponse)))(Hyper_Response.end(dictResponse));
                                                };
                                                if (v2 instanceof Data_Either.Right) {
                                                    var v3 = Hyper_ContentNegotiation.negotiateContent(v2.value0)(Type_Trout_ContentType.allMimeRender(dictAllMimeRender)(Type_Proxy["Proxy"].value)(v.value0));
                                                    if (v3 instanceof Hyper_ContentNegotiation.Match) {
                                                        return Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(Hyper_Status.statusOK))(Hyper_Response.contentType(dictMonad)(dictResponse)(v3.value0.value0)))(Hyper_Response.closeHeaders(dictResponse)))(Hyper_Response.respond(dictMonad)(dictResponseWritable)(dictResponse)(v3.value0.value1));
                                                    };
                                                    if (v3 instanceof Hyper_ContentNegotiation.Default) {
                                                        return Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(Hyper_Status.statusOK))(Hyper_Response.contentType(dictMonad)(dictResponse)(v3.value0.value0)))(Hyper_Response.closeHeaders(dictResponse)))(Hyper_Response.respond(dictMonad)(dictResponseWritable)(dictResponse)(v3.value0.value1));
                                                    };
                                                    if (v3 instanceof Hyper_ContentNegotiation.NotAcceptable) {
                                                        return Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Control_IxMonad.iapplySecond(Hyper_Middleware.ixMonadMiddleware(dictMonad))(Hyper_Response.writeStatus(dictResponse)(Hyper_Status.statusNotAcceptable))(Hyper_Response.contentType(dictMonad)(dictResponse)(Data_MediaType_Common.textPlain)))(Hyper_Response.closeHeaders(dictResponse)))(Hyper_Response.end(dictResponse));
                                                    };
                                                    throw new Error("Failed pattern match at Hyper.Trout.Router line 199, column 27 - line 214, column 38: " + [ v3.constructor.name ]);
                                                };
                                                throw new Error("Failed pattern match at Hyper.Trout.Router line 192, column 23 - line 214, column 38: " + [ v2.constructor.name ]);
                                            });
                                        };
                                        throw new Error("Failed pattern match at Hyper.Trout.Router line 184, column 19 - line 214, column 38: " + [ v.constructor.name ]);
                                    });
                                    return routeEndpoint(dictIsSymbol)(proxy)(context)(handler)(Data_Symbol.SProxy.value);
                                };
                            };
                        });
                    };
                };
            };
        };
    };
};
var genericRoutingError = new Data_Generic_Rep.Generic(function (x) {
    return new Data_Generic_Rep.Product(x.value0.message, x.value0.status);
}, function (x) {
    return new HTTPError({
        message: x.value0, 
        status: x.value1
    });
});
var showRoutingError = new Data_Show.Show(Data_Generic_Rep_Show.genericShow(genericRoutingError)(Data_Generic_Rep_Show.genericShowConstructor(Data_Generic_Rep_Show.genericShowArgsRec(Data_Generic_Rep_Show.genericShowFieldsProduct(Data_Generic_Rep_Show.genericShowFieldsField(Data_Maybe.showMaybe(Data_Show.showString))(new Data_Symbol.IsSymbol(function () {
    return "message";
})))(Data_Generic_Rep_Show.genericShowFieldsField(Hyper_Status.showStatus)(new Data_Symbol.IsSymbol(function () {
    return "status";
})))))(new Data_Symbol.IsSymbol(function () {
    return "HTTPError";
}))));
var eqRoutingError = new Data_Eq.Eq(Data_Generic_Rep_Eq.genericEq(genericRoutingError)(Data_Generic_Rep_Eq.genericEqConstructor(Data_Generic_Rep_Eq.genericEqRec(Data_Generic_Rep_Eq.genericEqProduct(Data_Generic_Rep_Eq.genericEqField(Data_Maybe.eqMaybe(Data_Eq.eqString)))(Data_Generic_Rep_Eq.genericEqField(Hyper_Status.eqStatus))))));
module.exports = {
    HTTPError: HTTPError, 
    MethodRouter: MethodRouter, 
    Router: Router, 
    route: route, 
    routeMethod: routeMethod, 
    router: router, 
    genericRoutingError: genericRoutingError, 
    eqRoutingError: eqRoutingError, 
    showRoutingError: showRoutingError, 
    routerAltE: routerAltE, 
    routerLit: routerLit, 
    routerCapture: routerCapture, 
    routerCaptureAll: routerCaptureAll, 
    methodRouterMethod: methodRouterMethod, 
    routerRaw: routerRaw, 
    routerResourceMethods: routerResourceMethods, 
    routerResource: routerResource
};
